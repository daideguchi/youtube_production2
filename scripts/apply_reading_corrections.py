#!/usr/bin/env python3
"""
読み補正を適用するスクリプト

script_sanitized.txt の内容を読み補正辞書に従って変換し、
誤読を防ぐためにひらがな化した script_corrected.txt を生成する。
"""
import re
from pathlib import Path
import argparse
import sys

from _bootstrap import bootstrap

REPO_ROOT = bootstrap()

from factory_common.paths import script_data_root


# 誤読しやすい単語と正しい読み（CH02 自己啓発/心理学コンテキスト向け）
READING_CORRECTIONS = {
    # ===================================================================
    # 複合語を先に定義（部分一致による誤変換を防止）
    # ===================================================================
    "一時間": "いちじかん",
    "一時的": "いちじてき",
    "一時停止": "いちじていし",
    "一時期": "いちじき",
    "一日中": "いちにちじゅう",
    "一日一日": "いちにちいちにち",
    "一行で": "いちぎょうで",
    
    # ===================================================================
    # 確実に修正すべきもの（文脈依存なし）
    # ===================================================================
    "放っておけ": "ほっておけ",
    "放っておく": "ほっておく", 
    "放っておい": "ほっておい",
    "放っておか": "ほっておか",
    "放っておけず": "ほっておけず",
    "何故": "なぜ",
    "未だ": "いまだ",
    "囁く": "ささやく",
    "囁き": "ささやき",
    "呟く": "つぶやく",
    "呟き": "つぶやき",
    "頷く": "うなずく",
    "頷き": "うなずき",
    "瞬く": "またたく",
    "傍ら": "かたわら",
    "傍観": "ぼうかん",
    "兎に角": "とにかく",
    "所謂": "いわゆる",
    "即ち": "すなわち",
    "或いは": "あるいは",
    "且つ": "かつ",
    "尤も": "もっとも",
    "専ら": "もっぱら",
    "殆ど": "ほとんど",
    "辛うじて": "かろうじて",
    "態々": "わざわざ",
    "態と": "わざと",
    "漸く": "ようやく",
    "忽ち": "たちまち",
    "矢張り": "やはり",
    "予め": "あらかじめ",
    "敢えて": "あえて",
    "概ね": "おおむね",
    "暫く": "しばらく",
    "尚更": "なおさら",
    "却って": "かえって",
    "寧ろ": "むしろ",
    "偶に": "たまに",
    "稀に": "まれに",
    "嘗て": "かつて",
    "殊更": "ことさら",
    "何時": "いつ",
    "何処": "どこ",
    "其処": "そこ",
    "彼処": "あそこ",
    "此処": "ここ",
    "自ら": "みずから",
    "互い": "たがい",
    "各々": "おのおの",
    "全て": "すべて",
    "悉く": "ことごとく",
    "唯": "ただ",
    "独り": "ひとり",
    "流石": "さすが",
    "蹲る": "うずくまる",
    "俯く": "うつむく",
    "躓く": "つまずく",
    "蔑む": "さげすむ",
    "侮る": "あなどる",
    "疎む": "うとむ",
    "妬む": "ねたむ",
    "羨む": "うらやむ",
    "慮る": "おもんぱかる",
    "慈しむ": "いつくしむ",
    "労う": "ねぎらう",
    "悼む": "いたむ",
    "惜しむ": "おしむ",
    "憚る": "はばかる",
    "偲ぶ": "しのぶ",
    "慕う": "したう",
    "漂う": "ただよう",
    "揺らぐ": "ゆらぐ",
    "閃く": "ひらめく",
    "煌めく": "きらめく",
    "眩しい": "まぶしい",
    "目眩": "めまい",
    "眩暈": "めまい",
    "茫然": "ぼうぜん",
    "呆然": "ぼうぜん",
    "愕然": "がくぜん",
    "慄然": "りつぜん",
    "粛然": "しゅくぜん",
    "凛然": "りんぜん",
    "毅然": "きぜん",
    "泰然": "たいぜん",
    "悠然": "ゆうぜん",
    "漠然": "ばくぜん",
    "朦朧": "もうろう",
    "憂鬱": "ゆううつ",
    "鬱陶しい": "うっとうしい",
    "煩わしい": "わずらわしい",
    "疎ましい": "うとましい",
    "厭わしい": "いとわしい",
    "忌まわしい": "いまわしい",
    "恨めしい": "うらめしい",
    "口惜しい": "くちおしい",
    "歯痒い": "はがゆい",
    "焦れったい": "じれったい",
    "苛立つ": "いらだつ",
    "苛つく": "いらつく",
    "戯れる": "たわむれる",
    "和む": "なごむ",
    "寛ぐ": "くつろぐ",
    "憩う": "いこう",
    "微笑む": "ほほえむ",
    "微睡む": "まどろむ",
    "佇む": "たたずむ",
    "項垂れる": "うなだれる",
    "萎れる": "しおれる",
    "萎える": "なえる",
    "俄か": "にわか",
    "仄か": "ほのか",
    "朧げ": "おぼろげ",
    "徐ろ": "おもむろ",
    "清々しい": "すがすがしい",
    "瑞々しい": "みずみずしい",
    "生々しい": "なまなましい",
    "相応しい": "ふさわしい",
    "慌ただしい": "あわただしい",
    "喧しい": "やかましい",
    "騒々しい": "そうぞうしい",
    "物々しい": "ものものしい",
    "畏まる": "かしこまる",
    "齧る": "かじる",
    "啄む": "ついばむ",
    "漱ぐ": "すすぐ",
    "啜る": "すする",
    "咽ぶ": "むせぶ",
    "咽る": "むせる",
    "嗚咽": "おえつ",
    "嗄れる": "かれる",
    "喘ぐ": "あえぐ",
    "喚く": "わめく",
    "吠える": "ほえる",
    "囀る": "さえずる",
    "躊躇う": "ためらう",
    "躊躇": "ちゅうちょ",
    "揶揄う": "からかう",
    "嘲笑う": "あざわらう",
    "蔑ろ": "ないがしろ",
    "弄ぶ": "もてあそぶ",
    "虐げる": "しいたげる",
    "苛む": "さいなむ",
    "虐める": "いじめる",
    "嬲る": "なぶる",
    "貶す": "けなす",
    "揶揄": "やゆ",
    "嘲る": "あざける",
    "罵る": "ののしる",
    "貪る": "むさぼる",
    "蠢く": "うごめく",
    "跪く": "ひざまずく",
    "強張る": "こわばる",
    "凍てつく": "いてつく",
    "凍える": "こごえる",
    "慄く": "おののく",
    "戦く": "おののく",
    "怯える": "おびえる",
    "怯む": "ひるむ",
    "竦む": "すくむ",
    "屈む": "かがむ",
    "撓む": "しなう",
    "捩る": "ねじる",
    "捻る": "ねじる",
    "萎む": "しぼむ",
    "萎びる": "しなびる",
    "紡ぐ": "つむぐ",
    "拵える": "こしらえる",
    "携える": "たずさえる",
    "携わる": "たずさわる",
    "踏襲": "とうしゅう",
    "凝視": "ぎょうし",
    "俯瞰": "ふかん",
    "邂逅": "かいこう",
    "謳歌": "おうか",
    "慟哭": "どうこく",
    "憤慨": "ふんがい",
    "落胆": "らくたん",
    "感銘": "かんめい",
    "感慨": "かんがい",
    
    # ===================================================================
    # CH02コンテキストで安全に変換できるもの
    # ===================================================================
    "一人": "ひとり",
    "二人": "ふたり",
    "大人": "おとな",
    "今日": "きょう",
    "明日": "あした",
    "昨日": "きのう",
    "今年": "ことし",
    "来年": "らいねん",
    "去年": "きょねん",
    "上手": "じょうず",
    "下手": "へた",
    "一度": "いちど",
    "一瞬": "いっしゅん",
    "一言": "ひとこと",
    "一歩": "いっぽ",
    "一緒": "いっしょ",
    "行方": "ゆくえ",
    "平穏": "へいおん",
    "静寂": "せいじゃく",
    "安堵": "あんど",
    "曖昧": "あいまい",
    "拘る": "こだわる",
    "拘り": "こだわり",
    "繋ぐ": "つなぐ",
    "繋がり": "つながり",
    "繋がる": "つながる",
    "溜める": "ためる",
    "溜め込む": "ためこむ",
    "溜まる": "たまる",
    "溜息": "ためいき",
    "塞ぐ": "ふさぐ",
    "塞がる": "ふさがる",
    "皆": "みな",
    "只": "ただ",
    "確か": "たしか",
    "穏やか": "おだやか",
    "速やか": "すみやか",
    "鮮やか": "あざやか",
    "健やか": "すこやか",
    "爽やか": "さわやか",
    "支える": "ささえる",
    "据える": "すえる",
    
    # 「一日」は「いちにち」と読むことが多い（CH02は自己啓発系）
    "一日": "いちにち",
    
    # 「一時」は単独では変換しない（複合語で対応）
    # Voicevoxは文脈から適切に読む可能性が高い
    # "一時": "いっとき",  # 削除: 一時間→いっとき間になる問題を防止
    
    # 「一息」は「ひといき」
    "一息": "ひといき",
    
    # 「最中」は「さいちゅう」（〜している最中）
    "最中": "さいちゅう",
    
    # 「直に」は「じきに」（すぐに）
    "直に": "じきに",
    
    # 「誰」は「だれ」
    "誰": "だれ",
    
    # 「彼」「彼女」は人称代名詞
    "彼": "かれ",
    "彼女": "かのじょ",
    
    # ===================================================================
    # 英語→カタカナ変換（TTSが読みにくい英語）
    # ===================================================================
    
    # --- 略語・頭字語 ---
    "NASA": "ナサ",
    "ESA": "イーエスエー",
    "CIA": "シーアイエー",
    "FBI": "エフビーアイ",
    "UFO": "ユーフォー",
    "UAP": "ユーエーピー",
    "DNA": "ディーエヌエー",
    "RNA": "アールエヌエー",
    "BBC": "ビービーシー",
    "GPS": "ジーピーエス",
    "NSA": "エヌエスエー",
    "KGB": "カーゲーベー",
    "KKK": "ケーケーケー",
    "GHQ": "ジーエイチキュー",
    "IBM": "アイビーエム",
    "MIT": "エムアイティー",
    "FRB": "エフアールビー",
    "GCHQ": "ジーシーエイチキュー",
    "HSCA": "エイチエスシーエー",
    "KGFL": "ケージーエフエル",
    "EBE": "イービーイー",
    "JFK": "ジェイエフケー",
    "USS": "ユーエスエス",
    "USA": "アメリカ",
    "DRE": "ディーアールイー",
    
    # --- IT・テクノロジー ---
    "AI": "エーアイ",
    "ChatGPT": "チャットジーピーティー",
    "GPT": "ジーピーティー",
    "Web": "ウェブ",
    "WWW": "ワールドワイドウェブ",
    "URL": "ユーアールエル",
    "QR": "キューアール",
    "PC": "パソコン",
    "OS": "オーエス",
    "IP": "アイピー",
    "VR": "ブイアール",
    "AR": "エーアール",
    "CG": "シージー",
    "SF": "エスエフ",
    "IT": "アイティー",
    "MRI": "エムアールアイ",
    "fMRI": "エフエムアールアイ",
    "CT": "シーティー",
    "Tor": "トーア",
    "Tails": "テイルズ",
    "RSA": "アールエスエー",
    "PGP": "ピージーピー",
    "TLP": "ティーエルピー",
    "NIT": "エヌアイティー",
    "TBM": "ティービーエム",
    "PBM": "ピービーエム",
    "RAS": "ラス",
    
    # --- 企業・サービス名 ---
    "Microsoft": "マイクロソフト",
    "Google": "グーグル",
    "YouTube": "ユーチューブ",
    "Twitter": "ツイッター",
    "Facebook": "フェイスブック",
    "Amazon": "アマゾン",
    "Apple": "アップル",
    "Tesla": "テスラ",
    "SpaceX": "スペースエックス",
    "iPhone": "アイフォン",
    "iPad": "アイパッド",
    "Bitcoin": "ビットコイン",
    "WikiLeaks": "ウィキリークス",
    "Yahoo": "ヤフー",
    "Bing": "ビング",
    "LINE": "ライン",
    "SNS": "エスエヌエス",
    "SecureDrop": "セキュアドロップ",
    "XKeyscore": "エックスキースコア",
    
    # --- 心理・医療用語 ---
    "LSD": "エルエスディー",
    "PTSD": "ピーティーエスディー",
    "EMDR": "イーエムディーアール",
    "HSP": "エイチエスピー",
    "FOMO": "フォーモ",
    "COVID": "コビッド",
    "SDGs": "エスディージーズ",
    "SETI": "セティ",
    "METI": "メティ",
    
    # --- 人名・固有名詞 ---
    "Hitler": "ヒトラー",
    "Caesar": "カエサル",
    "Mason": "メイソン",
    "Mafia": "マフィア",
    "Masonry": "メイソンリー",
    "Cicada": "シケイダ",
    "Anon": "アノン",
    "Yura": "ユラ",
    "Besa": "ベサ",
    "Chao": "チャオ",
    
    # --- 一般英単語 ---
    "Deep": "ディープ",
    "Secret": "シークレット",
    "Program": "プログラム",
    "System": "システム",
    "Space": "スペース",
    "Dream": "ドリーム",
    "Life": "ライフ",
    "World": "ワールド",
    "Great": "グレート",
    "New": "ニュー",
    "Open": "オープン",
    "Free": "フリー",
    "Mind": "マインド",
    "Side": "サイド",
    "End": "エンド",
    "Exit": "イグジット",
    "Node": "ノード",
    "Patch": "パッチ",
    "Router": "ルーター",
    "Earth": "アース",
    "Universe": "ユニバース",
    "Intelligence": "インテリジェンス",
    "Alternative": "オルタナティブ",
    "Assassination": "アサシネーション",
    "Extraterrestrial": "エクストラテレストリアル",
    "Onion": "オニオン",
    "Bright": "ブライト",
    "Wow": "ワオ",
    "Order": "オーダー",
    "Always": "オールウェイズ",
    "Sensitive": "センシティブ",
    "Person": "パーソン",
    "Highly": "ハイリー",
    "Look": "ルック",
    "Wide": "ワイド",
    "Swiss": "スイス",
    "Reticular": "レティキュラー",
    "Activating": "アクティベーティング",
    "Messaging": "メッセージング",
    "Agreeableness": "アグリーアブルネス",
    "Politics": "ポリティクス",
    "Speculative": "スペキュラティブ",
    "Architect": "アーキテクト",
    "RaaS": "ラース",
    "Fullz": "フルズ",
    "Vitrified": "ヴィトリファイド",
    "Forts": "フォーツ",
    "Starstuff": "スタースタッフ",
    "Shape": "シェイプ",
    "Shading": "シェーディング",
    "Mongolois": "モンゴロイス",
    "Stinks": "スティンクス",
    "chart": "チャート",
    "plateau": "プラトー",
    "privacy": "プライバシー",
    "spell": "スペル",
    "calling": "コーリング",
    "dream": "ドリーム",
    "love": "ラブ",
    "star": "スター",
    "santosha": "サントーシャ",
    "parentification": "ペアレンティフィケーション",
    "chan": "ちゃん",
    
    # --- ラテン語・古語 ---
    "ANNUIT": "アニュイット",
    "COEPTIS": "コエプティス",
    "NOVUS": "ノブス",
    "ORDO": "オルド",
    "SECLORUM": "セクロルム",
    "Luna": "ルナ",
    "Lunacy": "ルナシー",
    "Neron": "ネロン",
    "TIBERIVS": "ティベリウス",
    "CLAVDIVS": "クラウディウス",
    "ALH": "エーエルエイチ",
    "Hister": "ヒスター",
    "Liber": "リベル",
    "Primus": "プリムス",
    "Ordo": "オルド",
}


def apply_corrections(text: str) -> tuple[str, list[str]]:
    """読み補正を適用"""
    changes = []
    result = text
    
    # 長い単語から順にソート（部分一致対策）
    sorted_corrections = sorted(READING_CORRECTIONS.items(), key=lambda x: len(x[0]), reverse=True)
    
    for original, reading in sorted_corrections:
        if original in result:
            count = result.count(original)
            result = result.replace(original, reading)
            changes.append(f"  {original} → {reading} ({count}箇所)")
    
    return result, changes


def process_episode(episode_dir: Path, dry_run: bool = False, verbose: bool = False) -> tuple[bool, list[str]]:
    """1エピソードを処理"""
    audio_prep = episode_dir / "audio_prep"
    if not audio_prep.exists():
        return False, [f"audio_prep not found in {episode_dir}"]
    
    sanitized_path = audio_prep / "script_sanitized.txt"
    if not sanitized_path.exists():
        return False, [f"script_sanitized.txt not found in {audio_prep}"]
    
    # 読み込み
    with open(sanitized_path, 'r', encoding='utf-8') as f:
        original_text = f.read()
    
    # 補正適用
    corrected_text, changes = apply_corrections(original_text)
    
    if not changes:
        if verbose:
            print(f"  {episode_dir.name}: 変更なし")
        return True, []
    
    # 出力
    corrected_path = audio_prep / "script_corrected.txt"
    if not dry_run:
        with open(corrected_path, 'w', encoding='utf-8') as f:
            f.write(corrected_text)
        print(f"  {episode_dir.name}: {len(changes)}件の補正を適用 → script_corrected.txt")
    else:
        print(f"  {episode_dir.name}: {len(changes)}件の補正候補")
    
    if verbose:
        for change in changes:
            print(change)
    
    return True, changes


def main():
    parser = argparse.ArgumentParser(description="読み補正を適用してscript_corrected.txtを生成")
    parser.add_argument("--channel", required=True, help="チャンネルID (例: CH02)")
    parser.add_argument("--episode", help="エピソード番号 (例: 026) - 指定なしで全エピソード処理")
    parser.add_argument("--dry-run", action="store_true", help="実際には書き込まない")
    parser.add_argument("--verbose", "-v", action="store_true", help="詳細表示")
    args = parser.parse_args()
    
    base_path = script_data_root() / args.channel.upper()
    
    if not base_path.exists():
        print(f"Error: {base_path} not found")
        return
    
    if args.episode:
        episodes = [base_path / args.episode]
    else:
        episodes = sorted([d for d in base_path.iterdir() if d.is_dir() and d.name.isdigit()])
    
    print(f"チャンネル: {args.channel}")
    print(f"処理対象: {len(episodes)} エピソード")
    print(f"モード: {'ドライラン' if args.dry_run else '実行'}")
    print()
    
    total_changes = 0
    success_count = 0
    for episode_dir in episodes:
        success, changes = process_episode(episode_dir, args.dry_run, args.verbose)
        if success:
            success_count += 1
        total_changes += len(changes)
    
    print()
    print(f"完了: {success_count}/{len(episodes)} エピソード処理, 合計 {total_changes} 件の補正")


if __name__ == "__main__":
    main()
