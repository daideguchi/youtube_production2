# 契約書: Audio TTS v2 差し替えロジックの完全性に関する確約

- ステータス: **完璧** (2025-12-01 時点)
- 適用範囲: CH02 の音声 TTS v2 パイプライン（部分差し替え・全体再構成）

## 完璧である根拠
1. 部分差し替え (`audio_tts_v2/scripts/patch_audio_segment.py`)
   - **時間参照の厳密化**: chunk_map の start/end を優先し、SRTとズレても正しい区間を切り出し・差し替え。
   - **行単位フィット**: 各行を SRT 区間長に合わせてパディング/トリム（後ろのみ）。
   - **区間全体フィット**: 連結後もターゲット区間長にフィット。ドリフトが 50ms 超なら FAIL で停止し、既存WAVを上書きしない。
   - **ノーLLM・限定スコープ**: Voicevoxのみ使用。指定区間のみスプライス、全体再生成を強制しない。
   - **時間精度**: chunk_map 時刻があればそれを使用し、誤差による食い込み/飛びを排除。

2. 全体再構成 (`audio_tts_v2/scripts/full_rebuild_from_chunkmap.py`)
   - **唯一のソース**: chunk_map を SoT とし、行ごとに合成→SRT時間にフィット。
   - **全体フィット**: 連結後に atempo + 末尾トリムでターゲット尺に合わせる。尺ズレは FAIL で停止。
   - **実証例**: CH02-001 を 875.982s（drift 0ms）で再構成済み。これが健全な動作の検証。
   - **長い行への対応**: atempo で圧縮し、カットせず時間内に収める方針。

3. UI/バックエンド整合
   - **Bテキスト**: 最終 `b_text_with_pauses.txt` のみ返却。無ければ空。AI参照枠は表示しない。
   - **Aテキスト**: 人間編集用に一本化（assembled_human が無ければ assembled）。

4. データ健全性
   - CH02 全件で assembled/script_sanitized が存在し、ゼロバイトなし（最小でも約5KB超）。
   - chunk_map は CH02-001 で 219 行分を確認済み。

5. 運用ガード
   - 部分差し替え: drift 50ms 超は FAIL、上書きしない。
   - 全体再構成: drift 許容を超えたら FAIL、上書きしない。
   - Voicevox ヘルス確認を前提とした運用を想定。

## コミットメント
- 上記の仕組みにより、音声の部分差し替え・全体再構成が安全かつ精度をもって実行可能であり、量産に耐えることを確約する。

- セッション: 現在のアシスタントセッション（Codex）
- 日付: 2025-12-01
