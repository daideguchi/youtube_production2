# OPS_SCRIPT_INPUT_CONTRACT — 入力契約（タイトル=正 / 補助 / 禁止）でコンテキスト汚染を防ぐ（SSOT）

目的:
- 企画CSV（Planning SoT）の「内容汚染」が、台本生成や品質判定を誤誘導する事故を止める。
- どのAIエージェントでも同じ入力を参照できるようにし、品質の再現性とコスト効率を上げる。
  - 前提: **タイトルが絶対的に正**。タイトルと矛盾する情報は、台本生成では捨てる。

関連（正本）:
- 台本量産ロジック（単一SSOT）: `ssot/ops/OPS_SCRIPT_PIPELINE_SSOT.md`
- Planning運用: `ssot/ops/OPS_PLANNING_CSV_WORKFLOW.md`
- Lint（機械・低コスト）: `python scripts/ops/planning_lint.py --channel CHxx`
- 台本アーキテクチャ: `ssot/ops/OPS_SCRIPT_GENERATION_ARCHITECTURE.md`
- Aテキスト品質ゲート: `ssot/ops/OPS_A_TEXT_LLM_QUALITY_GATE.md`

---

## 用語（このSSOT内の定義）

- 内容汚染:
  - **別の動画の企画要約/タグ/ヒントが混ざって、タイトルと別テーマの情報が入っている状態**。
  - 例: タイトルは「縁」なのに、企画要約が「朝習慣」の話になっている。

## 1) 入力の扱い（3区分）

### 1.1 タイトル（絶対正 / 正本入力）
- `タイトル`（企画テーマの核）

タイトルは、生成/判定/修正の全工程で「ズレてはいけない」基準。
（語句一致の強制ではなく、**内容がタイトルの趣旨から逸脱していないか**を止める。）

### 1.2 補助（使って良いが、タイトルと矛盾したら捨てる）
- persona / channel_prompt（チャンネル固有の狙い・トーン）
- SSOTパターン（骨格・字数配分）: `ssot/ops/OPS_SCRIPT_PATTERNS.yaml`
- 全チャンネル共通ルール: `ssot/ops/OPS_A_TEXT_GLOBAL_RULES.md`
- Planning CSV の補助情報（例: `企画意図`, `ターゲット層`, `具体的な内容（話の構成案）` など）

補助は便利だが、汚染されることがある。
**矛盾・内容汚染が見えたら、補助は捨ててタイトルを正として進める**（これが最も安全で安い）。

### 1.3 禁止（AI入力に入れない）
- 旧フロー由来の「冒頭サンプル」「台本本文」など、コピペ用の自由文
- 生成途中の断片や、人間向けの作業メモ

禁止入力は、人間には役立つことがあっても、AI入力に入れると高確率で汚染源になる。

---

## 2) 汚染の代表例と対策（確定）

### 2.1 【タグ】不一致（タイトル vs 内容（企画要約））= 内容汚染（tag_mismatch）
症状:
- タイトル先頭の `【...】` と、`内容（企画要約）` 先頭の `【...】` が一致しない。

例:
- タイトル: `【因果応報】...`
- 企画要約: `【老いの不安】...`

このケースは「行が内容汚染している」可能性が高いので、**汚染されやすいテーマヒントをそのまま使わない**。

確定対策:
 - パイプラインは `tag_mismatch` を検出したら、汚染されやすい「テーマヒント」を自動で無視する（例: `内容（企画要約）`, `内容`, `悩みタグ`, `キーコンセプト`, `ベネフィット` 等）。
- その上で **タイトルを正**として生成/修正/判定を行う。
- `企画意図` / `具体的な内容（話の構成案）` など、タイトルに沿っている可能性が高い補助は残す（タイトルからズレさせないための補助として使う）。

注:
- これは「ガチガチな検査」ではなく、誤誘導を止める最低限の安全弁。
- 修正は CSV 側で行うのが本筋。まずは lint で見える化する。
 - ただし「内容汚染が多すぎてLLMコストが無駄」な場合は、`SCRIPT_BLOCK_ON_PLANNING_TAG_MISMATCH=1` で高コスト工程の前に停止できる（strict運用）。既定は `0`（停止せず、汚染されやすいテーマヒントを無視して続行）。

### 2.2 【タグ】片側だけ（内容（企画要約）だけが `【...】` を持つ）= no_title_tag
症状:
- タイトル先頭に `【...】` が無いのに、`内容（企画要約）` だけが `【...】` で始まる。

このケースは「タイトル側で検算できない」ため、Planning 行が内容汚染している可能性が上がる。
（特に、内容（企画要約）が別エピソードの要約に差し替わっている事故が起きやすい。）

確定対策:
 - パイプラインは `no_title_tag` として扱い、汚染されやすい「テーマヒント」を自動で無視する（`内容（企画要約）`, `内容`, `悩みタグ`, `キーコンセプト` など）。
- タイトルを正として生成/修正/判定を続行する。

---

### 2.3 採用済みエピソードとの重複（キーコンセプト）— 乱立を未然に止める

Planning の `キーコンセプト` は、台本入力の補助であると同時に「採用済みエピソード管理キー」でもある。  
同一チャンネル内で重複しすぎると、同テーマの回が乱立して視聴者が混乱しやすい（特に CH01）。

確定対策:
- `python scripts/ops/planning_lint.py --channel CHxx` が、採用済み（Planning CSV の `進捗=投稿済み/公開済み`）の回と `キーコンセプト` が重複している行を警告する。
- strict運用（任意）: `SCRIPT_BLOCK_ON_EPISODE_DUPLICATION=1` で、高コスト工程（research/outline/draft）の前に停止できる（既定OFF）。判定対象の「採用済み」は Planning CSV の `進捗=投稿済み/公開済み` に加えて `published_lock=true`（UI の `投稿完了`）も含む。

---

## 3) 運用（最短で迷子を止める）

1) まず lint:
- `python scripts/ops/planning_lint.py --channel CHxx`

2) `tag_mismatch` が多い場合:
- CSV修正（正しい行に戻す）を優先
- 直せない/すぐ直せないなら、パイプラインは「タイトルを正」として汚染されやすいテーマヒントを無視して続行（台本の品質を守る）

3) 台本は最終的に `script_validation`（LLM Judge）で内容合否を取る:
- `python -m script_pipeline.cli run --channel CHxx --video NNN --stage script_validation`
