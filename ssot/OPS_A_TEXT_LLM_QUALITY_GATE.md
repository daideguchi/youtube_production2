# OPS_A_TEXT_LLM_QUALITY_GATE — LLM審査（Judge）+ 微修正（Fixer）で台本品質を安定させる（SSOT）

目的:
- 「文字数だけ満たす最低品質」を **構造的に防止**する。
- Aテキスト（AIナレーション用の読み台本）が **狙い通り・自然・冗長なし** であることを、機械判定ではなく **推論モデルの判定**で担保する。

適用範囲（強制）:
- 全チャンネル / 全エピソードの `script_validation`（品質ゲート）に適用する。
- 台本本文（Aテキスト）SoT:
  - `workspaces/scripts/{CH}/{NNN}/content/assembled_human.md`（存在する場合の正本）
  - それ以外は `content/assembled.md`

関連（正本）:
- 全チャンネル共通の書式/禁則: `ssot/OPS_A_TEXT_GLOBAL_RULES.md`
- パイプライン確定フロー: `ssot/OPS_CONFIRMED_PIPELINE_FLOW.md`

---

## 1) 基本方針（LLM + ハードガードで品質を固定）

### 1.1 Judge（審査）
- 入力: チャンネル情報（persona / channel prompt / planning meta）+ Aテキスト本文 + 全チャンネル共通ルール（SSOT）
- 出力: **JSONのみ**（合否 + 指摘 + 最小修正方針）
- 役割: 台本が「視聴者にストレスなく伝わる」水準に達しているかを **推論で判定**する。

### 1.2 Fixer（微修正 / 外科手術）
- 入力: Judge のJSON指摘 + 同じ文脈情報 + Aテキスト本文
- 出力: **修正版の台本本文のみ**（説明禁止）
- 役割: Judge 指摘に従い、必要最小限の加除修正で品質を上げる。
  - ただし「水増し回避」を最優先し、厚みは **具体の追加**で作る。
  - 機械的な等間隔の `---` 挿入は禁止（文脈ベース）。
  - 可能な限り **既存本文を保持**し、問題のある段落だけを差し替える（全文リライトは最終手段）。

### 1.3 Extend（字数不足の救済 / 追記専用）
- 目的: Fixer が内容を良くした結果、字数が下限を割る事故を防ぐ（“短文化ループ”を止める）。
- 入力: Aテキスト本文 + 文字数状況（不足/超過） + 文脈情報（planning/persona/channel/SSOT）
- 出力: **追記後のAテキスト本文**（説明禁止）
- 原則:
  - 不足分は **中心テーマの理解が増える追記**で埋める（同趣旨の言い換えで埋めない）。
  - 追記は **1段落（または最大2段落）**に限定し、既存本文を大きく作り替えない。
  - 追記位置は文脈の切れ目（`---` の直後など）を選ぶ。終盤で急に別の例を足さない。

### 1.4 Rebuild（最終手段 / 作り直し）
- 目的: Judge が重大な冗長・反復・流れ崩壊を指摘し、Fixer で収束しない場合に “一貫性ある長文” を再構築する。
- 方式（推奨）:
  1) 設計図（プラン）を JSON で生成（セクション構成、中心エピソード、例の数、字数配分）
  2) 設計図に沿って Aテキスト本文を生成（`---` を文脈ベースで配置）
  3) ハード禁則（字数/区切り/URL等）→ Judge で最終合否
- 原則:
  - “字数合わせ” を目的にしない。字数は設計図の配分で満たす。
  - 例の連打は禁止。中心の仏教エピソードと、その理解が深まる説明に字数を使う。
  - 既出台本と同じ言い回し・同じ展開のコピーを避ける（内容の重複を防ぐ）。

---

## 2) Judge の必須チェック項目（合否の根拠）

Judge は次を **機械的ルールではなく文脈理解**で判定する。

- 流れ/接続: 唐突な段落・急な別話題・終盤の不自然な例の追加がないか
- 水増し検出: 同趣旨の言い換え連打、空疎な一般論、淡々とした繰り返しがないか
- 具体の質: 具体例が “説明の代わりの穴埋め” になっていないか（数だけ増やしていないか）
- 狙いの一貫性: planning（タイトル/企画意図/キーコンセプト）とズレていないか
- チャンネル指針: persona / script_prompt の要求（構成要素・トーン）が満たされているか
- 読み上げ適性: 句の長さ、息継ぎ、`---` の使い方、`「」`/`（）` の過剰使用がないか
- “GPT臭”の抑制: 不自然に硬い比喩、メタ的な言い回し、作り物感の強い文がないか
- 事実リスク: 根拠のない数値/研究/固有名詞の断定など、信頼を壊す危険がないか

合否:
- `pass`: そのまま音声生成に進める
- `fail`: Fixer による修正が必須（台本本文の書き直し/差し替えが発生する）

---

## 3) Fixer の修正原則（品質と安全）

- **核の維持**: 既存台本の「伝えたいこと」と中心エピソードは基本的に保持（ただし、核自体が弱い場合は Judge 指示に従い組み替え可）。
- **深く狭く**: 余計な話題を増やさず、主題の理解が深まる具体（状況・行動・心の動き・結果）を追加する。
- **例は厳選**: 人物例/エピソードの “連打” は避け、必要最小限で効果が出る配置にする。
- **禁則順守**: `ssot/OPS_A_TEXT_GLOBAL_RULES.md` の禁止事項を必ず守る（`---` 以外の区切り、URL/脚注/箇条書き等）。
- **文字数維持**: チャンネルの `target_chars_min/max` を厳守。削るだけで足りなくなる場合は、空疎な文を足さず “理解が増える具体” を足す。
- **短文化ループ防止**: Fixer 出力が字数下限を割った場合は、必要に応じて Extend（追記専用）で救済してから再審査する。

---

## 4) 失敗時の扱い（止め方）

- Fixer を最大N回回しても Judge が `pass` を返さない場合:
  - `script_validation` は `pending` に留め、`status.json` に Judge の指摘と最小修正方針を記録する。
  - 人間が `assembled_human.md`（なければ `assembled.md`）を手で直し、再実行する。

- Fixer/Extend がハード禁則（字数/見出し/箇条書き等）を満たせない場合:
  - `script_validation` は `pending` に留め、`fix_latest.md` と `judge_latest.json` を参照して修正方針を確定する。

注:
- URL/脚注/箇条書き/区切り記号などの **ハード禁則**は、従来どおり機械バリデータで検出して停止してよい（フロー品質の合否とは別）。
