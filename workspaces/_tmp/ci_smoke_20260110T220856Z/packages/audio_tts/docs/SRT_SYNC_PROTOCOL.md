# SRT Synchronization & Repair Protocol
**Status**: ACTIVE (v2.1 - Smart Reuse Implementation)
**Date**: 2025-12-07

## 1. Core Philosophy: "Audio is the Source of Truth"
To prevent desynchronization, the system **NEVER** estimates durations from text or relies on stale metadata.
*   **Absolute Rule**: The SRT `start` and `end` times are calculated ONLY by measuring the physical duration of the final `.wav` file (`_block_xxx.wav`).
*   **Data Flow**: `Text` -> `Audio File` -> `Measurement` -> `SRT Metadata`.

## 2. Logic Flow (Pipeline)

### A. Pre-Synthesis (Orchestrator)
When `run_tts.py` runs (even with `--regenerate-from-json`):
1.  **Sanitization**: `orchestrator.py` *strips* all `duration_sec`, `start`, `end` keys from loaded blocks.
    *   *Purpose*: Forces the system to re-verify audio duration every time. Prevents "stale usage".

### B. Synthesis (Voicevox/Full Phase)
Inside `synthesis.py`:
1.  **Block Iteration**: For every text block:
2.  **Existence Check**: Look for `_block_001.wav`.
3.  **Smart Reuse Logic**:
    *   **Case 1: Audio Exists**:
        *   Measure Duration (`dur`).
        *   **Sanity Check**: `if (text_len < 12 and dur > 8.0s) -> SUSPICIOUS`.
        *   **If Safe**: REUSE file. (Efficiency).
        *   **If Suspicious**: REGENERATE file. (Safety/Repair).
    *   **Case 2: Audio Missing**:
        *   REGENERATE.
4.  **Metadata Write**: The strictly measured `dur` is written to `srt_blocks.json`.

### C. Post-Processing
*   SRT file is generated by summing the valid `dur` values from Step B.

## 3. Repair Tools

### `scripts/repair_manager.py`
The standard tool for fixing video verification failures.
*   **Usage**: `python scripts/repair_manager.py [CHANNEL] [VIDEO_ID]`
*   **Workflow**:
    1.  **Clean Slate**: Deletes `srt_blocks.json` to remove potentially corrupt data.
    2.  **Execute Pipeline**: Runs `run_tts.py` in interactive mode.
    3.  **Auto-Audit**: Monitors for "Conscious Agent" token requests and auto-approves them (assuming manual oversight of the batch).
    4.  **Verify**: Checks that `srt_blocks.json` was recreated and contains valid non-zero timestamps.

## 4. Verification Checklist
When troubleshooting sync issues, verify in this order:
1.  **Physical Audio**: Play `_block_xxx.wav`. Is it the right length?
2.  **Metadata Alignment**: Does `srt_blocks.json` match the audio duration? (The `RepairManager` fixes this automatically).
3.  **SRT**: Does the `.srt` file match `srt_blocks.json`?

## 5. Artifact Locations
*   **Intermediate chunks (L2)**: `workspaces/scripts/[CHANNEL]/[NNN]/audio_prep/chunks/*.wav`
*   **Metadata (L2)**: `workspaces/scripts/[CHANNEL]/[NNN]/audio_prep/srt_blocks.json`
*   **Final (SoT, L1)**:
    * `workspaces/audio/final/[CHANNEL]/[NNN]/[CHANNEL]-[NNN].wav`
    * `workspaces/audio/final/[CHANNEL]/[NNN]/[CHANNEL]-[NNN].srt`
    * `workspaces/audio/final/[CHANNEL]/[NNN]/log.json`
    * `workspaces/audio/final/[CHANNEL]/[NNN]/audio_manifest.json`
