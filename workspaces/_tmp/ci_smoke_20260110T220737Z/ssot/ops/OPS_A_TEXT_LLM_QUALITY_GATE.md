# OPS_A_TEXT_LLM_QUALITY_GATE — LLM審査（Judge）+ 微修正（Fixer）で台本品質を安定させる（SSOT）

目的:
- 「文字数だけ満たす最低品質」を **構造的に防止**する。
- Aテキスト（AIナレーション用の読み台本）が **狙い通り・自然・冗長なし** であることを、機械判定ではなく **推論モデルの判定**で担保する。

適用範囲（強制）:
- 全チャンネル / 全エピソードの `script_validation`（品質ゲート）に適用する。
- 台本本文（Aテキスト）SoT:
  - `workspaces/scripts/{CH}/{NNN}/content/assembled_human.md`（存在する場合の正本）
  - それ以外は `content/assembled.md`

関連（正本）:
- 台本量産ロジック（単一SSOT）: `ssot/ops/OPS_SCRIPT_PIPELINE_SSOT.md`
- 全チャンネル共通の書式/禁則: `ssot/ops/OPS_A_TEXT_GLOBAL_RULES.md`
- パイプライン確定フロー: `ssot/ops/OPS_CONFIRMED_PIPELINE_FLOW.md`
- タイトル/サムネ↔台本の意味整合: `ssot/ops/OPS_SEMANTIC_ALIGNMENT.md`（`script_validation` 内で major は停止）

---

## 1) 基本方針（LLM + ハードガードで品質を固定）

### 1.0 ハードガード（機械チェック/非LLM）を先に通す
- `script_validation` はまず機械チェック（非LLM）で「禁則/字数/区切り/括弧上限」等を検査し、必要なら **TTS事故を防ぐための形式レベルの最小差分**（例: 行内 `---` の正規化、メタ混入の除去）だけを行ってから LLM Judge に渡す。
  - 括弧（鉤括弧/二重鉤括弧/丸括弧）の超過は、SSOT上の **ハード上限**として扱う（超過は不合格）。
  - 「重複段落を消す」「末尾を切る」など **内容に触れる決定論修正（機械台本テコ入れ）**は事故りやすいため **実装しない（禁止）**。  
    収束できない場合は “合格扱いにして書き込む” のではなく、要対応（書き手で修正→再実行）に回す。
  - 字数だけNG（`length_too_short/length_too_long`）を「自動で増補/圧縮して通す」運用は品質事故の原因になりうるため **禁止**。レンジ外は要リライトとして停止し、本文を自動で書き換えて合格扱いにしない（`SCRIPT_VALIDATION_AUTO_LENGTH_FIX` は廃止/無視）。
- LLM Judge は「流れ/冗長/反復/整合」の合否に集中させる（機械的な文字一致チェックをさせない）。
  - **「タイトルの語句が本文に出るか」は必須要件ではない**（意味として回収できているかで判定）。これだけで fail にしない。

### 1.0.1 Judge の“数え間違い”だけを補正する（任意・安全弁）
LLM Judge は「内容品質」を見るのが役割だが、**数え間違い**（`---` 本数、`「」/（）` の個数、人物例の数など）を起こすことがある。  
ここで誤って `must_fix` になり Fix ループが回るとコストが跳ねるため、`script_validation` では **客観的に検証できる“数”だけ**を（任意で）補正できる。

- デフォルトON（推奨）: `SCRIPT_VALIDATION_PRUNE_JUDGE_OBJECTIVE_MISCOUNTS=1`
  - `---` 本数（pause_lines）
  - `「」`/`（）` の上限（tts_hazard）
  - “人物例” の数え間違い（modern_examples_count）
- デフォルトOFF（非推奨）: `SCRIPT_VALIDATION_PRUNE_JUDGE_QUALITATIVE_MUST_FIX=1`
  - `repetition` / `poetic_filler` / `flow_break` など **内容品質の must_fix を決定論で消す**のは、低品質が pass する原因になりうるため通常は使わない。

### 1.1 Judge（審査）
- 入力: チャンネル情報（persona / a_text_channel_prompt（channel_promptから衝突要素を落とした派生） / planning meta）+ Aテキスト本文 + 全チャンネル共通ルール（SSOT）
- 出力: **JSONのみ**（合否 + 指摘 + 最小修正方針）
- 役割: 台本が「視聴者にストレスなく伝わる」水準に達しているかを **推論で判定**する。

### 1.2 Fixer（微修正 / 外科手術）
- 入力: Judge のJSON指摘 + 同じ文脈情報 + Aテキスト本文
- 出力: **修正版の台本本文のみ**（説明禁止）
- 役割: Judge 指摘に従い、必要最小限の加除修正で品質を上げる。
  - ただし「水増し回避」を最優先し、厚みは **具体の追加**で作る。
  - 機械的な等間隔の `---` 挿入は禁止（文脈ベース）。
  - 可能な限り **既存本文を保持**し、問題のある段落だけを差し替える（全文リライトは最終手段）。

重要（運用ルール）:
- Fixer/Extend/Expand/Shrink/Rebuild の **LLM出力は自動適用しない**（assembled*.md を勝手に書き換えない）。
- 生成物は `content/analysis/quality_gate/` 配下に **proposed（提案）**として保存し、`script_validation` は `pending` で停止する。
- 修正は書き手（人間/別工程）に戻し、対話AI監査で `redo_script` を再確定する。

### 1.2.1 Final Polish（最終納品の磨き込み / 任意）
目的:
- 章/セクションごとの “温度差” を消し、**トーン統一・反復抑制・概念混線解消** を 1 回で仕上げる。

位置づけ:
- `script_validation` の最後に、必要な場合だけ **最大1回**走らせる（常時ではない）。
- 出力は必ず `validate_a_text` に通し、かつ入力の `---` 本数/順序を維持できた場合だけ採用する（事故を混入させない）。

制御（Env）:
- `SCRIPT_VALIDATION_FINAL_POLISH=auto|0|1`
  - `auto`（既定）: 長尺（例: target_chars_min>=12000）など “崩れやすい条件” のときだけ実行。
  - `0`: 無効
  - `1`: 強制
- task: `SCRIPT_VALIDATION_FINAL_POLISH_TASK=script_a_text_final_polish`（既定）

### 1.3 Extend（字数不足の救済 / 追記専用）
- 目的: Fixer が内容を良くした結果、字数が下限を割る事故を防ぐ（“短文化ループ”を止める）。
- 入力: Aテキスト本文 + 文字数状況（不足/超過） + 文脈情報（planning/persona/channel/SSOT）
- 出力: **追記位置と追記本文のJSON**（本文は書き換えず、追記だけで埋める）
- 原則:
  - 不足分は **中心テーマの理解が増える追記**で埋める（同趣旨の言い換えで埋めない）。
  - 追記は **1段落（または最大2段落）**に限定し、既存本文を大きく作り替えない。
  - 追記位置は文脈の切れ目（`---` の直後など）を選ぶ。終盤で急に別の例を足さない。

### 1.4 Expand（字数不足が大きい場合の救済 / 追記のみ・複数箇所）
- 目的: Fixer 出力が大きく短くなり、Extend（1段落）では埋めきれない不足を、安全に追記だけで回復する。
- 入力: Aテキスト本文 + 文字数状況（不足） + 文脈情報（planning/persona/channel/SSOT）
- 出力: **追記位置と追記本文のJSON**（本文は書き換えず、追記だけで埋める）
- 原則:
  - 追記は最大3箇所まで、各1段落（空行なし）。`---` の直後など文脈の切れ目に入れる。
  - 新しい話題の増殖や具体例の連打は禁止（増やすなら最大1例まで）。
  - “抽象の水増し” をしない。理解が増える具体（状況→心の動き→教えの意味→具体行動）で厚みを作る。
- 収束の実装方針（現行）:
  - 不足が小さい（`<=1500`）は Extend（1段落）で埋める。
  - 不足が大きい（`>1500`）は Expand（複数箇所）で埋める。
  - `script_validation` の事前救済は **最大3パス（固定）**。上限でコスト暴走を防ぎつつ、3パス目まで打ち切らず「あと少し足りない」事故を潰す。

### 1.5 Shrink（字数超過の救済 / 削除・圧縮専用）
- 目的: Fixer が内容は良くても字数上限をわずかに超える場合に、意味と流れを保ったまま過剰分だけ削る。
- 入力: Aテキスト本文 + 文字数状況（超過） + 文脈情報（planning/persona/channel/SSOT）
- 出力: **短縮後のAテキスト本文**（説明禁止）
- 原則:
  - 追加は禁止。削除・圧縮のみで上限に収める。
  - 重要な中心エピソード/主張/手順は残し、冗長な言い換え・重複・弱い前置きを優先して削る。
  - `---` の位置や回数は原則維持し、機械的に増減しない。
- 収束の実装方針（現行）:
  - まず LLM Shrink を最大N回（既定: `SCRIPT_VALIDATION_AUTO_SHRINK_MAX_ROUNDS=5`）まで試す。
  - それでも `length_too_long` が残る場合は **pendingで停止**する（内容を機械的に削って合格扱いにしない）。
  - 例外は設けない（機械トリムは禁止）。残る場合は要対応（書き手で短縮→再実行）。

### 1.6 Rebuild（最終手段 / 作り直し）
- 目的: Judge が重大な冗長・反復・流れ崩壊を指摘し、Fixer で収束しない場合に “一貫性ある長文” を再構築する。
- 方式（推奨）:
  1) 設計図（プラン）を JSON で生成（セクション構成、中心エピソード、例の数、字数配分）
  2) 設計図に沿って Aテキスト本文を生成（`---` を文脈ベースで配置）
  3) ハード禁則（字数/区切り/URL等）→ Judge で最終合否
- 実装（現行）:
  - `SCRIPT_VALIDATION_LLM_REBUILD_ON_FAIL=1` のとき、Judge が最大回数で `fail` になった場合に **1回だけ** Rebuild を試す（SSOTパターン由来の設計図 → one-shot本文 → Judge）。
  - `pass` なら採用し、`fail` なら止める（無限ループにしない）。
  - 証跡: `content/analysis/quality_gate/rebuild_plan_latest.json`, `content/analysis/quality_gate/rebuild_draft_latest.md`
- 原則:
  - “字数合わせ” を目的にしない。字数は設計図の配分で満たす。
  - 例の連打は禁止。中心エピソードと、その理解が深まる説明に字数を使う。
  - 既出台本と同じ言い回し・同じ展開のコピーを避ける（内容の重複を防ぐ）。

### 1.7 収束のための「再判定スキップ」（迷子防止）
- 問題: LLM Judge は確率的なので、何度も回すと毎回別の懸念が出て「メタ作業ループ」に落ちやすい。
- 方針: `script_validation` は次を満たす場合、LLM Judge/Fixer を **スキップ**して即OKにする。
  - 前回 `verdict: pass`
  - Aテキスト本文と、判定に影響する文脈（persona / channel_prompt / 全体ルール / Judge/Fixerプロンプト）が **前回から変わっていない**
- 目的: “合格しているのに永遠に直し続ける” を構造的に防止する。
- 例外: 本当に再チェックしたい場合は `SCRIPT_VALIDATION_FORCE_LLM_GATE=1` で強制実行する。
- Rebuild は高コスト・高リスクなので、通常はOFFでよい（必要時のみ `SCRIPT_VALIDATION_LLM_REBUILD_ON_FAIL=1`）。

### 1.7.1 超長尺の自動スキップ（全文LLM事故防止）
2〜3時間級などの超長尺は「全文をLLMに渡す品質ゲート」がコンテキスト超過/高コスト/部分改変事故を起こしやすい。  
そのため `script_validation` は Aテキストが一定以上長い場合、LLM Judge/Fixer を **デフォルトでスキップ**する（機械チェックは実行する）。

- 既定閾値: `SCRIPT_VALIDATION_LLM_MAX_A_TEXT_CHARS=30000`（超過でスキップ）
- 例外:
  - 強制実行: `SCRIPT_VALIDATION_FORCE_LLM_GATE=1`
  - 無効化（常に実行したい）: `SCRIPT_VALIDATION_LLM_MAX_A_TEXT_CHARS=0`（ただし推奨しない）
- 超長尺は `scripts/ops/a_text_marathon_compose.py`（Marathon）で「章単位収束」を正本運用とする（詳細: `ssot/ops/OPS_LONGFORM_SCRIPT_SCALING.md`）。

### 1.8 収束の上限（終わる仕組み）
`script_validation` は「合格したのに永遠に直し続ける」「Fixが長引く」を防ぐため、LLM呼び出し回数に上限を持たせる。

デフォルト方針（推奨）:
- Judge: 最大3回（fail→Fix→Judge→Fix→Judge で収束させる）
  - 例外（実装/既定）: draft provenance が `codex_exec` の回は default/hard cap を **5** に引き上げる（冗長/反復が出やすく収束に追加ラウンドが必要なため）
- Fixer: 最大2回（必要な場合のみ）
- 文字数救済（Extend/Expand/Shrink）: **本文を自動で書き換えない**（提案生成が必要な場合でも最大1回まで。適用は手動）
- それでもNGなら **pendingで停止**（人間が `assembled_human.md` を直す）

意図:
- 「品質ゲート調整→再判定→また別の懸念…」のメタ作業ループを構造的に起こさない。
- “リトライで押し切る” ではなく、**最初のJudgeで本質的な欠陥だけを抽出し、Fixは原則一回（必要なら+1回）で収束させる**。

運用調整:
- `SCRIPT_VALIDATION_LLM_MAX_ROUNDS` で上書き可能（ただし hard cap: 通常=3, `codex_exec`=5）
- コストを優先して短く止めたい場合は `SCRIPT_VALIDATION_LLM_MAX_ROUNDS=2` に下げる（推奨: まずは既定で運用して失敗率を見てから）。

### 1.9 史実/逸話の安全性（作り話感の根絶）
CH07など「中心エピソード（逸話）」を扱う台本では、視聴者の信頼を落とす “それっぽい捏造” を最優先で排除する。

ルール:
- 逸話/たとえは、**安全な要点（safe_retelling）**の範囲で語る。
- 名前/場所/任務/年数など、出典が曖昧な細部を積み上げて「史実っぽい物語」にしない。
- 経典番号や逐語引用の断定はしない（CH別プロンプト優先）。

参照（SSOT）:
- 構成/逸話候補: `ssot/ops/OPS_SCRIPT_PATTERNS.yaml`（`core_episode_candidates`）

---

## 2) Judge の必須チェック項目（合否の根拠）

Judge は次を **機械的ルールではなく文脈理解**で判定する。

- 流れ/接続: 唐突な段落・急な別話題・終盤の不自然な例の追加がないか
- 水増し検出: 同趣旨の言い換え連打、空疎な一般論、淡々とした繰り返しがないか
- 具体の質: 具体例が “説明の代わりの穴埋め” になっていないか（数だけ増やしていないか）
- 狙いの一貫性: planning（タイトル/企画意図/キーコンセプト）とズレていないか
- チャンネル指針: persona / script_prompt の要求（構成要素・トーン）が満たされているか
- 読み上げ適性: 句の長さ、息継ぎ、`---` の使い方、`「」`/`『』`/`（）` の過剰使用がないか
- “GPT臭”の抑制: 不自然に硬い比喩、メタ的な言い回し、作り物感の強い文がないか
- 事実リスク: 根拠のない数値/研究/固有名詞の断定など、信頼を壊す危険がないか

合否:
- `pass`: そのまま音声生成に進める
- `fail`: Fixer による修正が必須（台本本文の書き直し/差し替えが発生する）

---

## 3) Fixer の修正原則（品質と安全）

- **核の維持**: 既存台本の「伝えたいこと」と中心エピソードは基本的に保持（ただし、核自体が弱い場合は Judge 指示に従い組み替え可）。
- **深く狭く**: 余計な話題を増やさず、主題の理解が深まる具体（状況・行動・心の動き・結果）を追加する。
- **例は厳選**: 人物例/エピソードの “連打” は避け、必要最小限で効果が出る配置にする。
- **禁則順守**: `ssot/ops/OPS_A_TEXT_GLOBAL_RULES.md` の禁止事項を必ず守る（`---` 以外の区切り、URL/脚注/箇条書き等）。
- **文字数維持**: チャンネルの `target_chars_min/max` を厳守。削るだけで足りなくなる場合は、空疎な文を足さず “理解が増える具体” を足す。
- **短文化ループ防止**: Fixer 出力が字数下限を割った場合は、必要に応じて Extend/Expand（追記専用）で救済してから再審査する。

---

## 4) 失敗時の扱い（止め方）

- Fixer を最大N回回しても Judge が `pass` を返さない場合:
  - `script_validation` は `pending` に留め、`status.json` に Judge の指摘と最小修正方針を記録する。
  - 人間が `assembled_human.md`（なければ `assembled.md`）を手で直し、再実行する。

- Fixer/Extend/Expand/Shrink がハード禁則（字数/見出し/箇条書き等）を満たせない場合:
  - `script_validation` は `pending` に留め、`fix_latest.md` と `judge_latest.json` を参照して修正方針を確定する。

注:
- URL/脚注/箇条書き/区切り記号などの **ハード禁則**は、従来どおり機械バリデータで検出して停止してよい（フロー品質の合否とは別）。
