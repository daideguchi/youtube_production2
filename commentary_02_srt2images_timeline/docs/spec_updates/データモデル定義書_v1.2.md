# データモデル定義書 (Update v1.2)

> **最終更新**: 2025-11-19
> **バージョン**: 1.2
> **変更点**: 型定義（Domain Schema）の導入、SSOTファイルの拡張

---

## 2. SoT（Single Source of Truth）構造

### 2.1 SoT一覧（更新）

| 領域 | SoTパス | 形式 | 実装モデル | 更新方法 |
|------|---------|------|------------|---------|
| チャンネル設定 | `config/channel_presets.json` | JSON | `ChannelRegistry` | 手動（開発者） |
| スタイル定義 | `config/master_styles_v2.json` | JSON | `VideoStyle` | 手動（開発者） |
| 画像指示 | `output/.../image_cues.json` | JSON | `ImageCuesData` | LLM生成 |

---

## 7. 型定義（Domain Schema）

システム全体で共有されるPydanticモデル定義。
`src/core/domain/` 配下に配置し、UI/API/CLI共通で利用する。

### 7.1 スタイル定義 (`style_schema.py`)

動画の構成要素を論理的に定義するスキーマ。

```python
class VideoStyle(BaseModel):
    name: str
    canvas_width: int = 1920
    canvas_height: int = 1080
    subtitle_style: TextStyle
    belt_style: Optional[TextStyle]
    audio: AudioMixing
    visual: VisualStyle
    structure: TimelineStructure
    platform_overrides: dict  # CapCut/Remotion固有値
```

**TextStyle**:
- `font_family`, `font_size_pt`, `text_color` (Hex)
- `background_enabled`, `background_color`, `background_opacity`
- `position_x`, `position_y`, `alignment` (Logical: -1.0 to 1.0)

### 7.2 チャンネル設定 (`channel_schema.py`)

`channel_presets.json` の構造定義。

```python
class ChannelConfig(BaseModel):
    name: str
    status: str = "active"
    capcut_template: Optional[str]
    position: ChannelPosition  # tx, ty, scale
    belt: BeltConfig          # enabled, offset
    video_style: Optional[VideoStyle]
    capcut_settings: Optional[CapCutSettings] # Legacy override
```

### 7.3 アセット定義 (`asset_schema.py`)

`image_cues.json` の構造定義。

```python
class ImageCue(BaseModel):
    start_sec: float
    end_sec: float
    duration_sec: float
    content: str
    image_prompt: str
    image_path: Optional[str]

class ImageCuesData(BaseModel):
    fps: int = 30
    size: dict
    cues: List[ImageCue]
```

---

## 8. Platform Adapter

論理的なスタイル定義 (`VideoStyle`) を各プラットフォームの実装値に変換する層。

### 8.1 CapCut Adapter (`style_mapper.py`)

*   **入力**: `VideoStyle`
*   **出力**: `pyJianYingDraft` 用の辞書 (`Text_style`, `Clip_settings` 等)
*   **変換ロジック**:
    *   座標変換: Logical Y (0.8) → CapCut Y (-0.8)
    *   サイズ変換: Font pt → CapCut internal size
    *   色変換: Hex (`#FFFFFF`) → RGB Tuple (`(1.0, 1.0, 1.0)`)

---

**UI実装者への注記**:
フォーム生成やバリデーションには、必ず `src/core/domain/*.py` のPydanticモデルを参照すること。生のJSON操作は禁止とする。
