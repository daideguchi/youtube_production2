#!/usr/bin/env python3
"""台本16再生成: ラポール・ミラーリング（6500字目標）"""

import os
import re
import google.generativeai as genai

# Gemini設定
genai.configure(api_key=os.getenv('GEMINI_API_KEY'))
model = genai.GenerativeModel('gemini-2.5-pro')

# 超厳格な形式指示（文字数強調）
strict_format = '''
【絶対遵守】出力形式の厳守:

【ルール1】1行は必ず27文字以内（これを超えたら即エラー）
【ルール2】1セクションは必ず1行または2行のみ（3行以上は絶対禁止）
【ルール3】セクション終わりに必ず「///」
【ルール4】前置き・見出し・箇条書き一切禁止
【ルール5】最初の行からすぐに台本本文を開始すること
【ルール6】括弧 () （） を一切使わないこと
【ルール7】読点は適度に使用（少なめ・1行に最大2個まで）
【ルール8】総文字数は必ず6500字以上（厳守・これが最重要）

【文字数確保の方法】:
- 各セクションで十分に詳しく解説する
- 具体例を豊富に盛り込む
- 比喩や問いかけを効果的に使う
- 7つのセクション全てを丁寧に展開
- セクション3と4は特に長めに（各1500字程度）

【良い例（詳細な解説）】:
なぜか、この人の前だと
安心して何でも話してしまう。///

あなたの周りに、
そんな不思議な魅力を持つ人はいませんか？///

初対面なのに、昔からの
友人のように感じられたり、///

気づけば、普段は言わないような
本音まで打ち明けていたり。///

この現象、実は多くの人が
相性が良いと片付けてしまいがちです。///

【目標文字数】: 6500-7000字を厳守してください
'''

# プロンプト読み込み
with open('scripts/アカシック台本プロンプト', 'r', encoding='utf-8') as f:
    base_prompt = f.read()

# テーマ指示（詳細版・文字数強調）
theme = '''
【台本16: ラポールとミラーリング - 人から大切にされるコミュニケーション術】（目標6500字以上）

このテーマで、心理学とスピリチュアルな視点から人間関係構築の技術を解説する台本を作成してください。

【重要】各セクションで十分に詳しく書いてください。短くまとめないでください。

【セクション1: 導入】（目標800字）
- 人から大切にされる人の不思議な魅力
- 「相性」や「人柄」では説明できない現象
- 科学的に解明された「心の技術」の存在
- この動画で得られる具体的なスキル
- 視聴の呼びかけ

【セクション2: 核心概念】（目標900字）
- ラポールの正確な定義と本質
- 「信頼関係」との違い
- 無意識レベルでの安心感
- 心理学における位置づけ
- ミラーリングとの関係性

【セクション3: 深掘り - ラポールの本質】（目標1500字・最重要）
- ラポールの3つの層を詳しく解説:
  1. 表面的ラポール（挨拶・笑顔）- 具体例3つ以上
  2. 感情的ラポール（共感・理解）- 具体例3つ以上
  3. 深層的ラポール（魂の共鳴）- 具体例2つ以上
- それぞれのラポールがどう作用するか
- ラポール形成の科学的メカニズム
- 脳科学・神経言語プログラミングの知見

【セクション4: 実践方法 - ミラーリング技術】（目標1500字・最重要）
- ミラーリングの3つの実践:
  1. 言語的ミラーリング - 詳しいやり方
  2. 非言語的ミラーリング - 具体的ステップ
  3. 感情的ミラーリング - 実践例3つ以上
- 日常での具体的な訓練法
- 自然なミラーリングのコツ
- やってはいけないNG行動

【セクション5: 課題への対処】（目標800字）
- うまくいかない時の対処法
- 相手に不快感を与えない方法
- 高次の視点からの解釈
- 即効性と長期的効果の両立
- 失敗からの学び

【セクション6: 究極の目的】（目標900字）
- 真の人間関係とは何か
- 魂レベルでの繋がり
- 無条件の愛と受容
- テクニックを超えた境地
- 人生を豊かにする人間関係

【セクション7: 結論】（目標700字）
- 全体のまとめ
- 今日から始められること
- 行動喚起
- 励ましのメッセージ
- 視聴者への感謝

【文章の質】:
- 抽象的な説明だけでなく、必ず具体例を豊富に
- 視聴者が共感できる日常的な例
- 深い洞察と希望を与える内容
- わかりやすく、心に響く表現

【絶対に守ること】:
- 短くまとめない
- 各セクションで十分に詳しく書く
- 具体例を豊富に盛り込む
- 最終的に6500字以上を確保
'''

print('🧠 Gemini 2.5 Pro: 台本16再生成開始（6500字目標）...')
response = model.generate_content(strict_format + base_prompt + theme)

# 前処理（メタコメント・見出し削除）
content = response.text
content = re.sub(r'^.*?[\n]*(なぜか|あなたの|もし|人間関係|この|ラポール)', r'\1', content, flags=re.DOTALL)
content = re.sub(r'###\s*セクション\d+:.*?\n\n?', '', content)
content = re.sub(r'\n{3,}', '\n\n', content)

# 保存
with open('scripts/16_アカシック台本', 'w', encoding='utf-8') as f:
    f.write(content)

print(f'✅ 台本16再生成完了: scripts/16_アカシック台本')
print(f'📊 文字数: {len(content)}文字')

# 即座に品質チェック
import subprocess
result = subprocess.run(
    ['python3', 'tools/script_quality_checker.py', 'scripts/16_アカシック台本'],
    capture_output=True,
    text=True
)
print(result.stderr)
print(result.stdout)
