#!/usr/bin/env python3
"""台本4再々生成: カルマの法則と魂の成長（6500字目標）"""

import os
import re
import google.generativeai as genai

# Gemini設定
genai.configure(api_key=os.getenv('GEMINI_API_KEY'))
model = genai.GenerativeModel('gemini-2.5-pro')

# 超厳格な形式指示（文字数強調）
strict_format = '''
【絶対遵守】出力形式の厳守:

【ルール1】1行は必ず27文字以内（これを超えたら即エラー）
【ルール2】1セクションは必ず1行または2行のみ（3行以上は絶対禁止）
【ルール3】セクション終わりに必ず「///」
【ルール4】前置き・見出し・箇条書き一切禁止
【ルール5】最初の行からすぐに台本本文を開始すること
【ルール6】括弧 () （） を一切使わないこと
【ルール7】読点は適度に使用（少なめ・1行に最大2個まで）
【ルール8】総文字数は必ず6500字以上（厳守・これが最重要）

【文字数確保の方法】:
- 各セクションで十分に詳しく解説する
- 具体例を豊富に盛り込む
- 比喩や問いかけを効果的に使う
- 7つのセクション全てを丁寧に展開
- セクション3と4は特に長めに（各1500字程度）

【良い例（詳細な解説）】:
カルマという言葉を聞いて、
あなたは何を思いますか。///

多くの人は、何か怖いもの、
過去の過ちへの罰と捉えます。///

しかし、アカシックレコードに記された、
真実は全く違うのです。///

カルマとは、宇宙が用意した、
魂を成長させる愛の仕組み。///

それは、あなたを苦しめるものではなく、
本来の輝きを取り戻すための地図です。///

【目標文字数】: 6500-7000字を厳守してください
'''

# プロンプト読み込み
with open('scripts/アカシック台本プロンプト', 'r', encoding='utf-8') as f:
    base_prompt = f.read()

# テーマ指示（さらに詳細版・文字数強調）
theme = '''
【台本4: カルマの法則と魂の成長】（目標6500字以上）

このテーマで、アカシックレコードとスピリチュアルな視点からカルマの法則を解説する台本を作成してください。

【重要】各セクションで十分に詳しく書いてください。短くまとめないでください。

【セクション1: 導入】（目標800字）
- カルマに対する一般的な誤解
- 本当のカルマの意味
- この動画で得られる気づき
- 視聴の呼びかけ

【セクション2: 核心概念】（目標900字）
- カルマの正確な定義
- 罰ではなく愛の法則である理由
- アカシックレコードとの関係
- 魂の学習計画としてのカルマ
- 宇宙の完璧なバランスシステム

【セクション3: 深掘り】（目標1500字・最重要）
- カルマの3つの層を詳しく解説:
  1. 個人的カルマ（今世の行い）- 具体例3つ以上
  2. 過去世からのカルマ（魂の宿題）- 具体例3つ以上
  3. 集合的カルマ（家族・民族）- 具体例2つ以上
- それぞれのカルマがどう作用するか
- 偶然はないという真実

【セクション4: 実践方法】（目標1500字・最重要）
- カルマを変容させる3つの実践:
  1. 気づきと自己観察 - 詳しいやり方
  2. 反応から応答への転換 - 具体的ステップ
  3. 愛と許しの実践 - 実践例3つ以上
- 日常での具体的な訓練法
- 思考転換の力

【セクション5: 課題への対処】（目標800字）
- うまくいかない時の対処法
- 困難が訪れる本当の理由
- 高次の視点からの解釈
- カルマは固定されていないという希望
- 失敗からの学び

【セクション6: 究極の目的】（目標900字）
- カルマからの卒業とは
- 悟り・解脱の境地
- 宇宙意識との一体化
- 真の自由とは何か
- 魂の故郷への帰還

【セクション7: 結論】（目標700字）
- 全体のまとめ
- 今日から始められること
- 行動喚起
- 励ましのメッセージ
- 視聴者への感謝

【文章の質】:
- 抽象的な説明だけでなく、必ず具体例を豊富に
- 視聴者が共感できる日常的な例
- 深い洞察と希望を与える内容
- わかりやすく、心に響く表現

【絶対に守ること】:
- 短くまとめない
- 各セクションで十分に詳しく書く
- 具体例を豊富に盛り込む
- 最終的に6500字以上を確保
'''

print('🧠 Gemini 2.5 Pro: 台本4再々生成開始（6500字目標）...')
response = model.generate_content(strict_format + base_prompt + theme)

# 前処理（メタコメント・見出し削除）
content = response.text
content = re.sub(r'^.*?[\n]*(カルマ|あなたの|もし|なぜ|私たち|魂)', r'\1', content, flags=re.DOTALL)
content = re.sub(r'###\s*セクション\d+:.*?\n\n?', '', content)
content = re.sub(r'\n{3,}', '\n\n', content)

# 保存
with open('scripts/4_アカシック台本', 'w', encoding='utf-8') as f:
    f.write(content)

print(f'✅ 台本4再々生成完了: scripts/4_アカシック台本')
print(f'📊 文字数: {len(content)}文字')

# 即座に品質チェック
import subprocess
result = subprocess.run(
    ['python3', 'tools/script_quality_checker.py', 'scripts/4_アカシック台本'],
    capture_output=True,
    text=True
)
print(result.stderr)
print(result.stdout)
