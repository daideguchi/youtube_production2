<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mobile Start</title>
    <link rel="stylesheet" href="../styles.css?v=20260118_03" />
    <style>
      .start-card {
        border: 1px solid var(--border);
        background: rgba(15, 23, 48, 0.72);
        border-radius: 14px;
        padding: 14px;
      }
      .start-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .start-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }
      .start-actions .btn {
        font-size: 14px;
        padding: 12px 14px;
        border-radius: 12px;
      }
      .start-input {
        width: 100%;
        border: 1px solid var(--border);
        background: rgba(17, 26, 51, 0.55);
        color: var(--text);
        border-radius: 12px;
        padding: 12px 14px;
        font-size: 16px;
        outline: none;
      }
      .channel-list {
        display: grid;
        grid-template-columns: 1fr;
        gap: 10px;
        margin-top: 10px;
      }
      .channel-row {
        display: grid;
        grid-template-columns: 72px 1fr auto;
        gap: 10px;
        align-items: center;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(11, 17, 32, 0.55);
      }
      .channel-row__code {
        font-weight: 800;
        letter-spacing: 0.02em;
      }
      .channel-row__meta {
        display: grid;
        gap: 2px;
      }
      .channel-row__actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
      .channel-row__actions .btn {
        padding: 10px 12px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <section class="start-card">
        <h1 style="margin: 0 0 6px 0">Mobile Start</h1>
        <div class="muted">
          このURLをブックマーク: <code>/m/</code>（スマホ用の入口）
        </div>
        <div class="start-actions" aria-label="SSOT quick links">
          <a class="btn btn--ghost" href="../guide/">SSOT Guide</a>
          <a id="editFixedLogic" class="btn btn--ghost" target="_blank" rel="noreferrer">確定ロジック（編集）</a>
          <a id="editContactBox" class="btn btn--ghost" target="_blank" rel="noreferrer">CONTACT_BOX（編集）</a>
        </div>
      </section>

      <section class="start-card start-grid" aria-label="主要ページ">
        <div>
          <div style="font-weight: 700; margin-bottom: 6px">最初に開く</div>
          <div class="muted">台本・サムネ・動画内画像を、エピソード単位で迷わず見たい</div>
          <div class="start-actions">
            <a class="btn btn--primary" href="../ep/">エピソード一覧（推奨）</a>
            <a class="btn btn--ghost" href="../snapshot/">企画/進捗（snapshot）</a>
            <a class="btn btn--ghost" href="../guide/">Guide（全体像/運用）</a>
          </div>
        </div>

        <div>
          <div style="font-weight: 700; margin-bottom: 6px">検索したい</div>
          <div class="muted">台本を検索してコピーしたい（Script Viewer）</div>
          <div class="start-actions">
            <a class="btn btn--ghost" href="../">Script Viewer</a>
            <a class="btn btn--ghost" href="../archive/">書庫（Releases）</a>
          </div>
        </div>

        <div>
          <div style="font-weight: 700; margin-bottom: 6px">直リンクで開く</div>
          <div class="muted">例: <code>CH27-030</code></div>
          <form id="jumpForm" style="margin-top: 10px">
            <input id="jumpInput" class="start-input" inputmode="text" autocomplete="off" placeholder="CH27-030" />
            <div class="start-actions">
              <button class="btn btn--primary" type="submit">開く</button>
              <span id="jumpStatus" class="muted"></span>
            </div>
          </form>
        </div>
      </section>

      <section class="start-card" aria-label="チャンネル一覧">
        <div style="font-weight: 700; margin-bottom: 6px">チャンネル一覧（企画/台本の本数）</div>
        <div class="muted">
          ※ 企画/進捗の正本は Planning CSV。ここは静的スナップショット（読み取り専用）。
        </div>
        <div style="margin-top: 10px">
          <input
            id="channelListFilter"
            class="start-input"
            inputmode="text"
            autocomplete="off"
            placeholder="絞り込み: CH27 / 27"
          />
          <div id="channelsMeta" class="muted" style="margin-top: 8px"></div>
          <div id="channelsBody" class="channel-list" aria-label="Channels"></div>
        </div>
      </section>
    </div>

    <script>
      (function () {
        const form = document.getElementById("jumpForm");
        const input = document.getElementById("jumpInput");
        const status = document.getElementById("jumpStatus");
        if (!form || !input) return;

        function normalizeChannel(raw) {
          const m = String(raw || "")
            .trim()
            .toUpperCase()
            .match(/^CH(\\d{1,2})$/);
          if (!m) return "";
          return `CH${String(parseInt(m[1], 10)).padStart(2, "0")}`;
        }

        function normalizeVideo(raw) {
          const s = String(raw || "").trim();
          if (!/^\\d{1,3}$/.test(s)) return "";
          return String(parseInt(s, 10)).padStart(3, "0");
        }

        form.addEventListener("submit", (ev) => {
          ev.preventDefault();
          if (status) status.textContent = "";
          const raw = String(input.value || "").trim();
          const m = raw.toUpperCase().match(/^CH(\\d{1,2})[-_ ]?(\\d{1,3})$/);
          if (!m) {
            if (status) status.textContent = "形式: CHxx-NNN（例: CH27-030）";
            return;
          }
          const ch = normalizeChannel(`CH${m[1]}`);
          const vv = normalizeVideo(m[2]);
          if (!ch || !vv) {
            if (status) status.textContent = "形式: CHxx-NNN（例: CH27-030）";
            return;
          }
          window.location.href = `../ep/${ch}/${vv}/`;
        });
      })();
    </script>

    <script>
      (function () {
        const body = document.getElementById("channelsBody");
        const meta = document.getElementById("channelsMeta");
        const filter = document.getElementById("channelListFilter");
        if (!body) return;

        function normalizeChannelQuery(raw) {
          const s = String(raw || "").trim().toUpperCase();
          if (!s) return "";
          if (/^CH\\d{1,2}$/.test(s)) return s.replace(/^CH(\\d+)$/, (_, n) => `CH${String(Number(n)).padStart(2, "0")}`);
          if (/^\\d{1,2}$/.test(s)) return `CH${String(Number(s)).padStart(2, "0")}`;
          return s;
        }

        function el(tag, className, text) {
          const node = document.createElement(tag);
          if (className) node.className = className;
          if (text != null) node.textContent = String(text);
          return node;
        }

        function renderChannels(channels, generatedAt, q) {
          body.innerHTML = "";
          const query = normalizeChannelQuery(q);
          const filtered = query
            ? channels.filter((c) => String(c.channel || "").toUpperCase().includes(query))
            : channels;

          if (meta) {
            const ts = generatedAt ? `updated=${generatedAt}` : "";
            meta.textContent = `${filtered.length}/${channels.length} ${ts}`.trim();
          }

          for (const c of filtered) {
            const ch = String(c.channel || "").trim();
            const planning = Number(c.planning_count || 0);
            const scripts = Number(c.scripts_count || 0);

            const row = el("div", "channel-row");
            row.appendChild(el("div", "channel-row__code", ch || "—"));

            const metaBox = el("div", "channel-row__meta");
            metaBox.appendChild(el("div", "muted", `企画: ${planning}`));
            metaBox.appendChild(el("div", "muted", `台本: ${scripts}`));
            row.appendChild(metaBox);

            const actions = el("div", "channel-row__actions");
            const ep = el("a", "btn btn--primary", "EP");
            ep.href = `../ep/${ch}/`;
            const snap = el("a", "btn btn--ghost", "進捗");
            snap.href = `../snapshot/?channel=${encodeURIComponent(ch)}`;
            actions.appendChild(ep);
            actions.appendChild(snap);
            row.appendChild(actions);

            body.appendChild(row);
          }
        }

        async function boot() {
          try {
            const res = await fetch("../data/snapshot/channels.json", { cache: "no-store" });
            if (!res.ok) throw new Error(`channels.json fetch failed: ${res.status} ${res.statusText}`);
            const obj = await res.json();
            const channels = Array.isArray(obj?.channels) ? obj.channels : [];
            channels.sort((a, b) => String(a.channel || "").localeCompare(String(b.channel || "")));
            renderChannels(channels, String(obj?.generated_at || ""), "");

            if (filter) {
              filter.addEventListener("input", () => {
                renderChannels(channels, String(obj?.generated_at || ""), String(filter.value || ""));
              });
            }
          } catch (err) {
            if (meta) meta.textContent = `チャンネル一覧の取得に失敗: ${String(err)}`;
          }
        }

        void boot();
      })();
    </script>

    <script>
      (function () {
        const fixedLogic = document.getElementById("editFixedLogic");
        const contactBox = document.getElementById("editContactBox");
        if (!fixedLogic && !contactBox) return;

        function guessGitHubRepoFromPages() {
          const host = String(window.location.hostname || "");
          const m = host.match(/^([^.]+)\\.github\\.io$/);
          if (!m) return null;
          const owner = m[1];
          const parts = String(window.location.pathname || "")
            .split("/")
            .filter(Boolean);
          const repo = parts.length ? parts[0] : "";
          if (!owner || !repo) return null;
          return { owner, repo };
        }

        function encodePath(path) {
          return String(path || "")
            .split("/")
            .map((seg) => encodeURIComponent(seg))
            .join("/");
        }

        const guessed = guessGitHubRepoFromPages();
        const owner = guessed?.owner || "daideguchi";
        const repo = guessed?.repo || "youtube_production2";
        const branch = "main";
        const editBase = `https://github.com/${owner}/${repo}/edit/${branch}/`;

        if (fixedLogic) {
          fixedLogic.href =
            editBase +
            encodePath("ssot/reference/【消さないで！人間用】確定ロジック.md");
        }
        if (contactBox) {
          contactBox.href = editBase + encodePath("ssot/reference/CONTACT_BOX.md");
        }
      })();
    </script>
  </body>
</html>
